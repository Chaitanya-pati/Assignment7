<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheat Quality Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }

        .status-pending {
            color: #ff6b35;
        }

        .status-confirmed {
            color: #28a745;
        }

        .status-rejected {
            color: #dc3545;
        }

        .status-completed {
            color: #6c757d;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
        }

        .sidebar {
            min-height: 100vh;
            background: #f8f9fa;
        }

        .main-content {
            padding: 20px;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }

        .badge-category {
            font-size: 0.9em;
            padding: 0.5em 0.75em;
        }

        .dashboard-card {
            border-left: 4px solid #667eea;
        }

        .alert-custom {
            border-left: 4px solid #28a745;
        }

        .decision-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .decision-card {
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
        }

        .photo-capture-container {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            width: 120px;
            height: 120px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

            .photo-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .photo-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
        }

        .video-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #000;
        }

        .camera-controls {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .quality-alert {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .quality-parameters {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .parameter-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .parameter-value {
            font-weight: bold;
        }

        .parameter-status {
            font-size: 0.85em;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .status-good {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .workflow-step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }

        .step-complete {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .step-active {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .notification-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 300px;
            z-index: 1050;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .notification-urgent {
            border-left: 4px solid #dc3545;
        }

        .notification-info {
            border-left: 4px solid #17a2b8;
        }

        .claim-decision-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .weight-display {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            margin: 15px 0;
        }

        .inventory-update {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .btn-raise-claim {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            border: none;
            color: white;
        }

        .btn-approve-quality {
            background: linear-gradient(45deg, #28a745, #2ecc71);
            border: none;
            color: white;
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .receipt-preview {
            background: white;
            border: 2px solid #ddd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Notification Panel -->
    <div id="notificationPanel" class="notification-panel" style="display: none;"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-seedling"></i> Wheat Quality System</a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-info btn-sm me-2" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" class="badge bg-danger">0</span>
                </button>
                <span class="navbar-text me-3">Welcome, <span id="currentUser">Production Manager</span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <div class="nav flex-column nav-pills mt-3">
                    <button class="nav-link active" onclick="showModule('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button class="nav-link" onclick="showModule('vehicles')">
                        <i class="fas fa-truck"></i> Vehicle Entry
                    </button>
                    <button class="nav-link" onclick="showModule('suppliers')">
                        <i class="fas fa-building"></i> Supplier Management
                    </button>
                    <button class="nav-link" onclick="showModule('samples')">
                        <i class="fas fa-flask"></i> Sample Entry
                    </button>
                    <button class="nav-link" onclick="showModule('tests')">
                        <i class="fas fa-microscope"></i> Lab Testing
                    </button>
                    <button class="nav-link" onclick="showModule('confirmations')">
                        <i class="fas fa-check-circle"></i> Owner Decisions
                    </button>
                    <button class="nav-link" onclick="showModule('unloading')">
                        <i class="fas fa-warehouse"></i> Unloading & Weighing
                    </button>
                    <button class="nav-link" onclick="showModule('inventory')">
                        <i class="fas fa-boxes"></i> Inventory Management
                    </button>
                    <button class="nav-link" onclick="showModule('claims')">
                        <i class="fas fa-exclamation-triangle"></i> Quality Claims
                    </button>
                    <button class="nav-link" onclick="showModule('reports')">
                        <i class="fas fa-chart-bar"></i> Reports
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content">
                <!-- Dashboard Module -->
                <div id="dashboard" class="module">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-tachometer-alt"></i> Production Dashboard</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h6>Total Vehicles Today</h6>
                                            <h3 id="totalVehicles">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h6>Pending Owner Decisions</h6>
                                            <h3 id="pendingDecisions">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h6>Active Quality Claims</h6>
                                            <h3 id="activeClaims">0</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card dashboard-card">
                                        <div class="card-body">
                                            <h6>Today's Inventory (MT)</h6>
                                            <h3 id="todayInventory">0</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Workflow Status -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h6><i class="fas fa-flow-chart"></i> Current Workflow Status</h6>
                                </div>
                                <div class="card-body" id="workflowStatus">
                                    <!-- Dynamic workflow steps will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Vehicle Entry Module -->
                <div id="vehicles" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-truck"></i> Vehicle Entry & Photo Capture</h5>
                            <button class="btn btn-light btn-sm" onclick="openVehicleModal()">
                                <i class="fas fa-plus"></i> Register New Vehicle
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>Enhanced Workflow:</strong> Register vehicle details and capture multiple photos of vehicle and wheat load for quality documentation.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Vehicle No</th>
                                            <th>Driver</th>
                                            <th>Arrival Time</th>
                                            <th>Supplier</th>
                                            <th>Photos</th>
                                            <th>Gross Weight (MT)</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vehicleTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Lab Testing Module -->
                <div id="tests" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-microscope"></i> Lab Testing & Quality Assessment</h5>
                            <button class="btn btn-light btn-sm" onclick="openTestModal()">
                                <i class="fas fa-plus"></i> Add Test Result
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Lab Workflow:</strong> After testing, either mark as "Quality Approved" or "Raise Quality Claim" based on manual assessment.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Sample ID</th>
                                            <th>Vehicle No</th>
                                            <th>Test Results</th>
                                            <th>Quality Assessment</th>
                                            <th>Test Date</th>
                                            <th>Lab Decision</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="testTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Owner Decision Module -->
                <div id="confirmations" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-user-tie"></i> Owner/Production Manager Decisions</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>Decision Authority:</strong> Review lab reports, assign storage locations, and manage quality claims with supplier coordination.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Vehicle No</th>
                                            <th>Supplier</th>
                                            <th>Lab Report</th>
                                            <th>Quality Status</th>
                                            <th>Storage Assignment</th>
                                            <th>Decision Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="confirmationTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Unloading & Weighing Module -->
                <div id="unloading" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-warehouse"></i> Unloading & Weight Calculation</h5>
                            <button class="btn btn-light btn-sm" onclick="openUnloadingModal()">
                                <i class="fas fa-plus"></i> Record Unloading
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-scale-balanced"></i>
                                <strong>Weighing Process:</strong> Record empty vehicle weight and calculate net wheat weight automatically.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Vehicle No</th>
                                            <th>Storage Area</th>
                                            <th>Gross Weight (MT)</th>
                                            <th>Empty Weight (MT)</th>
                                            <th>Net Weight (MT)</th>
                                            <th>Unloading Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="unloadingTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Inventory Management Module -->
                <div id="inventory" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-boxes"></i> Inventory Management</h5>
                            <button class="btn btn-light btn-sm" onclick="generateInventoryReport()">
                                <i class="fas fa-file-alt"></i> Generate Report
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h6><i class="fas fa-warehouse"></i> Storage Areas</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="storageAreas"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6><i class="fas fa-chart-pie"></i> Category Distribution</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="categoryBreakdown"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-4">
                                <div class="card-header">
                                    <h6><i class="fas fa-history"></i> Recent Inventory Updates</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date/Time</th>
                                                    <th>Vehicle</th>
                                                    <th>Category</th>
                                                    <th>Weight Added (MT)</th>
                                                    <th>Storage Area</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventoryHistoryBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Quality Claims Module -->
                <div id="claims" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-exclamation-triangle"></i> Quality Claims Management</h5>
                            <button class="btn btn-light btn-sm" onclick="openClaimModal()">
                                <i class="fas fa-plus"></i> Manual Claim Entry
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-phone"></i>
                                <strong>Claim Process:</strong> Claims are raised by lab technicians. Owner contacts supplier externally and records mutual agreement before authorizing unloading.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Claim ID</th>
                                            <th>Vehicle No</th>
                                            <th>Supplier</th>
                                            <th>Quality Issues</th>
                                            <th>Claim Date</th>
                                            <th>Supplier Response</th>
                                            <th>Resolution Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="claimTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other existing modules -->
                <div id="suppliers" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-building"></i> Supplier Management</h5>
                            <button class="btn btn-light btn-sm" onclick="openSupplierModal()">
                                <i class="fas fa-plus"></i> Add Supplier
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Supplier Name</th>
                                            <th>Contact Person</th>
                                            <th>Phone</th>
                                            <th>Address</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supplierTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="samples" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-flask"></i> Sample Entry</h5>
                            <button class="btn btn-light btn-sm" onclick="openSampleModal()">
                                <i class="fas fa-plus"></i> Collect Sample
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Sample ID</th>
                                            <th>Vehicle No</th>
                                            <th>Supplier</th>
                                            <th>Sampling Time</th>
                                            <th>Bags Count</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sampleTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reports" class="module" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-bar"></i> Reports & Analytics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Daily Summary</h6>
                                            <div id="dailySummary"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Quality Analysis</h6>
                                            <div id="qualityAnalysis"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>Supplier Performance</h6>
                                            <div id="supplierPerformance"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Vehicle Modal -->
    <div class="modal fade" id="vehicleModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vehicle Entry & Photo Documentation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="vehicleEditIndex">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Number *</label>
                            <input type="text" id="vehicleNumber" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Driver Name *</label>
                            <input type="text" id="driverName" class="form-control" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">Arrival Time *</label>
                            <input type="datetime-local" id="arrivalTime" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Supplier *</label>
                            <select id="supplierSelect" class="form-select" required>
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Gross Weight (MT) *</label>
                            <input type="number" id="grossWeight" class="form-control" step="0.1" required>
                        </div>
                    </div>

                    <!-- Enhanced Photo Capture Section -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <label class="form-label"><strong><i class="fas fa-camera"></i> Vehicle & Wheat Load Photos</strong></label>
                            <div class="photo-capture-container">
                                <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                                <h6>Capture Multiple Photos for Quality Documentation</h6>
                                <p class="text-muted">Take photos of: Vehicle exterior, Driver documents, Wheat load, Loading condition</p>

                                <div id="cameraSection" style="display: none;">
                                    <video id="cameraVideo" class="video-preview" autoplay></video>
                                    <div class="camera-controls">
                                        <button type="button" id="captureBtn" class="btn btn-success">
                                            <i class="fas fa-camera"></i> Capture Photo
                                        </button>
                                        <button type="button" id="stopCameraBtn" class="btn btn-secondary">
                                            <i class="fas fa-stop"></i> Stop Camera
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button type="button" id="startCameraBtn" class="btn btn-info me-2">
                                        <i class="fas fa-video"></i> Start Camera
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('fileInput').click()">
                                        <i class="fas fa-upload"></i> Upload from Device
                                    </button>
                                    <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                                </div>
                            </div>
                            <div id="photoPreview" class="photo-gallery"></div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> Photos will be securely stored and linked to this vehicle record for quality traceability.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="saveVehicle()">
                        <i class="fas fa-save"></i> Save Vehicle & Photos
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Test Modal -->
    <div class="modal fade" id="testModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lab Test Results & Quality Decision</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="testEditIndex">
                    <div class="mb-3">
                        <label class="form-label">Sample *</label>
                        <select id="testSampleSelect" class="form-select" required>
                            <option value="">Select Sample</option>
                        </select>
                    </div>

                    <div class="quality-parameters">
                        <h6><i class="fas fa-microscope"></i> Test Parameters</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Moisture % *</label>
                                <input type="number" id="moisturePercent" class="form-control" step="0.1" required>
                                <small class="text-muted">Standard: ≤12% (Premium), ≤14% (Mill)</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Foreign Matter % *</label>
                                <input type="number" id="foreignMatterPercent" class="form-control" step="0.1" required>
                                <small class="text-muted">Standard: ≤1% (Premium), ≤2% (Mill)</small>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Color Grade *</label>
                                <select id="colorGrade" class="form-select" required>
                                    <option value="">Select Color</option>
                                    <option value="Excellent">Excellent</option>
                                    <option value="Good">Good</option>
                                    <option value="Fair">Fair</option>
                                    <option value="Poor">Poor</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Auto Category</label>
                                <input type="text" id="categoryResult" class="form-control" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Test Date *</label>
                        <input type="datetime-local" id="testDate" class="form-control" required>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Lab Technician Notes</label>
                        <textarea id="testNotes" class="form-control" rows="3" placeholder="Enter any observations or additional notes..."></textarea>
                    </div>

                    <!-- Lab Decision Section -->
                    <div class="mt-4">
                        <h6><i class="fas fa-clipboard-check"></i> Lab Quality Decision</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Based on manual assessment, choose the appropriate action:
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button type="button" id="approveQualityBtn" class="btn btn-approve-quality btn-lg">
                                        <i class="fas fa-check-circle"></i> Quality Approved
                                    </button>
                                    <small class="text-muted mt-1">Forward to Owner for category assignment</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid">
                                    <button type="button" id="raiseClaimBtn" class="btn btn-raise-claim btn-lg">
                                        <i class="fas fa-exclamation-triangle"></i> Raise Quality Claim
                                    </button>
                                    <small class="text-muted mt-1">Send to Owner for supplier coordination</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveTest()">
                        <i class="fas fa-save"></i> Save Test Result
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Owner Decision Modal -->
    <div class="modal fade" id="ownerDecisionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Owner/Production Manager Decision</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="decisionTestIndex">

                    <div id="approvedWheatSection" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Quality Approved Wheat</strong>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Final Category Assignment *</label>
                                <select id="finalCategory" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="Premium">Premium</option>
                                    <option value="Mill">Mill Grade</option>
                                    <option value="Low Mill">Low Mill</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Storage Area Assignment *</label>
                                <select id="storageArea" class="form-select" required>
                                    <option value="">Select Storage Area</option>
                                    <option value="Godown A">Godown A</option>
                                    <option value="Godown B">Godown B</option>
                                    <option value="Godown C">Godown C</option>
                                    <option value="Warehouse 1">Warehouse 1</option>
                                    <option value="Warehouse 2">Warehouse 2</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="claimWheatSection" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Quality Claim Raised</strong>
                        </div>
                        <div class="claim-decision-panel">
                            <h6><i class="fas fa-phone"></i> Supplier Coordination</h6>
                            <p class="mb-3">Contact supplier externally to discuss quality issues and reach mutual agreement.</p>

                            <div class="mb-3">
                                <label class="form-label">Supplier Contact Status</label>
                                <select id="supplierContactStatus" class="form-select">
                                    <option value="">Select Status</option>
                                    <option value="Contacted">Supplier Contacted</option>
                                    <option value="Discussing">Under Discussion</option>
                                    <option value="Agreed">Mutual Agreement Reached</option>
                                    <option value="Rejected">Claim Rejected by Supplier</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Agreement Details</label>
                                <textarea id="agreementDetails" class="form-control" rows="3" placeholder="Record the details of agreement with supplier..."></textarea>
                            </div>

                            <div class="row" id="claimResolutionSection" style="display: none;">
                                <div class="col-md-6">
                                    <label class="form-label">Final Category Assignment</label>
                                    <select id="claimFinalCategory" class="form-select">
                                        <option value="">Select Category</option>
                                        <option value="Premium">Premium</option>
                                        <option value="Mill">Mill Grade</option>
                                        <option value="Low Mill">Low Mill</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Storage Area Assignment</label>
                                    <select id="claimStorageArea" class="form-select">
                                        <option value="">Select Storage Area</option>
                                        <option value="Godown A">Godown A</option>
                                        <option value="Godown B">Godown B</option>
                                        <option value="Godown C">Godown C</option>
                                        <option value="Warehouse 1">Warehouse 1</option>
                                        <option value="Warehouse 2">Warehouse 2</option>
                                        <option value="Rejection Area">Rejection Area</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Owner Decision Notes</label>
                        <textarea id="ownerNotes" class="form-control" rows="3" placeholder="Enter decision rationale and any additional notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="saveOwnerDecision()">
                        <i class="fas fa-check"></i> Confirm Decision & Authorize Unloading
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Unloading Modal -->
    <div class="modal fade" id="unloadingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Unloading & Weight Calculation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="unloadingEditIndex">

                    <div class="mb-3">
                        <label class="form-label">Authorized Vehicle *</label>
                        <select id="unloadingVehicleSelect" class="form-select" required>
                            <option value="">Select Authorized Vehicle</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Gross Weight (MT)</label>
                            <input type="number" id="unloadingGrossWeight" class="form-control" step="0.1" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Empty Vehicle Weight (MT) *</label>
                            <input type="number" id="emptyWeight" class="form-control" step="0.1" required>
                        </div>
                    </div>

                    <div class="weight-display" id="netWeightDisplay">
                        Net Wheat Weight: <span id="netWeightValue">0.0</span> MT
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Unloading Start Time *</label>
                            <input type="datetime-local" id="unloadingStartTime" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unloading End Time *</label>
                            <input type="datetime-local" id="unloadingEndTime" class="form-control" required>
                        </div>
                    </div>

                    <div class="inventory-update">
                        <h6><i class="fas fa-plus-circle"></i> Inventory Update Preview</h6>
                        <p><strong>Storage Area:</strong> <span id="previewStorageArea">-</span></p>
                        <p><strong>Category:</strong> <span id="previewCategory">-</span></p>
                        <p><strong>Weight to Add:</strong> <span id="previewWeight">0.0</span> MT</p>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">Unloading Notes</label>
                        <textarea id="unloadingNotes" class="form-control" rows="3" placeholder="Enter any observations during unloading..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="saveUnloading()">
                        <i class="fas fa-check"></i> Complete Unloading & Update Inventory
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delivery Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Delivery Receipt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="receipt-preview" id="receiptContent">
                        <!-- Receipt content will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="printReceipt()">
                        <i class="fas fa-print"></i> Print Receipt
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadReceipt()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other existing modals (Supplier, Sample, Claim) remain the same -->
    <div class="modal fade" id="supplierModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Supplier Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="supplierEditIndex">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Supplier Name</label>
                            <input type="text" id="supplierName" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact Person</label>
                            <input type="text" id="contactPerson" class="form-control" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="supplierPhone" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" id="supplierEmail" class="form-control">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label class="form-label">Address</label>
                            <textarea id="supplierAddress" class="form-control" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select id="supplierStatus" class="form-select" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sampleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sample Collection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="sampleEditIndex">
                    <div class="mb-3">
                        <label class="form-label">Vehicle</label>
                        <select id="sampleVehicleSelect" class="form-select" required>
                            <option value="">Select Vehicle</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sampling Time</label>
                        <input type="datetime-local" id="samplingTime" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Number of Bags Sampled</label>
                        <input type="number" id="bagsCount" class="form-control" min="40" max="50" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea id="sampleNotes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveSample()">Save Sample</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="claimModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manual Claim Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="claimEditIndex">
                    <div class="mb-3">
                        <label class="form-label">Vehicle</label>
                        <select id="claimVehicleSelect" class="form-select" required>
                            <option value="">Select Vehicle</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quality Issues</label>
                        <textarea id="claimReason" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Claim Date</label>
                        <input type="datetime-local" id="claimDate" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="saveClaim()">Save Claim</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Enhanced Global Data Storage
        let vehicles = [];
        let suppliers = [];
        let samples = [];
        let tests = [];
        let claims = [];
        let unloadings = [];
        let ownerDecisions = [];
        let inventory = {};
        let inventoryHistory = [];
        let vehiclePhotos = {};
        let notifications = [];
        let currentStream = null;

        // Initialize App with Enhanced Features
        function initializeApp() {
            loadData();
            populateSupplierDropdowns();
            updateDashboard();
            setCurrentDateTime();
            initializeCameraControls();
            initializeInventory();
            loadNotifications();
            updateWorkflowStatus();
        }

        // Enhanced Core Functions
        function showModule(moduleId) {
            document.querySelectorAll('.module').forEach(module => {
                module.style.display = 'none';
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const moduleElement = document.getElementById(moduleId);
            if (moduleElement) {
                moduleElement.style.display = 'block';
            }

            const clickedLink = document.querySelector(`[onclick="showModule('${moduleId}')"]`);
            if (clickedLink) {
                clickedLink.classList.add('active');
            }

            switch(moduleId) {
                case 'dashboard':
                    updateDashboard();
                    updateWorkflowStatus();
                    break;
                case 'vehicles': loadVehicleTable(); break;
                case 'suppliers': loadSupplierTable(); break;
                case 'samples': loadSampleTable(); break;
                case 'tests': loadTestTable(); break;
                case 'confirmations': loadConfirmationTable(); break;
                case 'unloading': loadUnloadingTable(); break;
                case 'inventory': loadInventoryModule(); break;
                case 'claims': loadClaimTable(); break;
                case 'reports': loadReports(); break;
            }
        }

        // Enhanced Vehicle Management
        function openVehicleModal(index = null) {
            const modal = new bootstrap.Modal(document.getElementById('vehicleModal'));

            // Reset form
            document.getElementById('vehicleEditIndex').value = '';
            document.getElementById('vehicleNumber').value = '';
            document.getElementById('driverName').value = '';
            document.getElementById('arrivalTime').value = '';
            document.getElementById('supplierSelect').value = '';
            document.getElementById('grossWeight').value = '';
            document.getElementById('photoPreview').innerHTML = '';

            if (index !== null) {
                const vehicle = vehicles[index];
                document.getElementById('vehicleEditIndex').value = index;
                document.getElementById('vehicleNumber').value = vehicle.vehicleNumber;
                document.getElementById('driverName').value = vehicle.driverName;
                document.getElementById('arrivalTime').value = vehicle.arrivalTime;
                document.getElementById('supplierSelect').value = vehicle.supplier;
                document.getElementById('grossWeight').value = vehicle.grossWeight || '';
                document.querySelector('#vehicleModal .modal-title').textContent = 'Edit Vehicle Entry';

                const photos = vehiclePhotos[vehicle.vehicleNumber] || [];
                photos.forEach(photo => {
                    addPhotoToPreview(photo.data, photo.name);
                });
            } else {
                document.querySelector('#vehicleModal .modal-title').textContent = 'Vehicle Entry & Photo Documentation';
                setCurrentDateTime('arrivalTime');
            }
            modal.show();
        }

        function saveVehicle() {
            const index = document.getElementById('vehicleEditIndex').value;
            const vehicleNumber = document.getElementById('vehicleNumber').value;
            const driverName = document.getElementById('driverName').value;
            const arrivalTime = document.getElementById('arrivalTime').value;
            const supplier = document.getElementById('supplierSelect').value;
            const grossWeight = parseFloat(document.getElementById('grossWeight').value);

            if (!vehicleNumber || !driverName || !arrivalTime || !supplier || !grossWeight) {
                showAlert('Please fill all required fields', 'warning');
                return;
            }

            const photos = getVehiclePhotos();
            if (photos.length === 0) {
                if (!confirm('No photos captured. Are you sure you want to proceed without photos?')) {
                    return;
                }
            }

            const vehicle = {
                vehicleNumber: vehicleNumber,
                driverName: driverName,
                arrivalTime: arrivalTime,
                supplier: supplier,
                grossWeight: grossWeight,
                status: 'Photos Captured - Pending Sampling',
                entryTime: new Date().toISOString(),
                photoCount: photos.length
            };

            if (photos.length > 0) {
                vehiclePhotos[vehicleNumber] = photos;
            }

            if (index === '' || index === undefined) {
                vehicles.push(vehicle);
                addNotification(`New vehicle ${vehicleNumber} registered with ${photos.length} photos`, 'info');
            } else {
                vehicles[parseInt(index)] = { ...vehicles[parseInt(index)], ...vehicle };
                addNotification(`Vehicle ${vehicleNumber} updated`, 'info');
            }

            saveDataToMemory();
            loadVehicleTable();
            updateDashboard();
            populateVehicleDropdowns();

            const vehicleModal = bootstrap.Modal.getInstance(document.getElementById('vehicleModal'));
            if (vehicleModal) vehicleModal.hide();

            showAlert('Vehicle saved successfully with photo documentation!', 'success');
            stopCamera();
        }

        function loadVehicleTable() {
            const tbody = document.getElementById('vehicleTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            vehicles.forEach((vehicle, index) => {
                const statusClass = getStatusClass(vehicle.status);
                const photos = vehiclePhotos[vehicle.vehicleNumber] || [];
                const photoDisplay = photos.length > 0 ?
                    `<span class="text-success"><i class="fas fa-camera"></i> ${photos.length} photo(s)</span>` :
                    '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> No photos</span>';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${vehicle.vehicleNumber}</strong></td>
                        <td>${vehicle.driverName}</td>
                        <td>${new Date(vehicle.arrivalTime).toLocaleString()}</td>
                        <td>${vehicle.supplier}</td>
                        <td>${photoDisplay}</td>
                        <td><strong>${vehicle.grossWeight || 'N/A'} MT</strong></td>
                        <td><span class="badge ${statusClass}">${vehicle.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openVehicleModal(${index})" title="Edit Vehicle">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewVehiclePhotos('${vehicle.vehicleNumber}')" title="View Photos">
                                <i class="fas fa-images"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteVehicle(${index})" title="Delete Vehicle">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function viewVehiclePhotos(vehicleNumber) {
            const photos = vehiclePhotos[vehicleNumber] || [];
            if (photos.length === 0) {
                showAlert('No photos available for this vehicle', 'info');
                return;
            }

            let photoHtml = `
                <div class="modal fade" id="photoViewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Vehicle Photos - ${vehicleNumber}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="photo-gallery">
            `;

            photos.forEach((photo, index) => {
                photoHtml += `
                    <div class="photo-item">
                        <img src="${photo.data}" alt="${photo.name}" style="cursor: pointer;" onclick="expandPhoto('${photo.data}')">
                        <div class="mt-1 text-center">
                            <small class="text-muted">${photo.name}</small>
                        </div>
                    </div>
                `;
            });

            photoHtml += `
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('photoViewModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', photoHtml);
            const modal = new bootstrap.Modal(document.getElementById('photoViewModal'));
            modal.show();
        }

        // Enhanced Test Management with Lab Decision Workflow
        function openTestModal(index = null) {
            const modal = new bootstrap.Modal(document.getElementById('testModal'));
            populateSampleDropdowns();

            // Reset form
            document.getElementById('testEditIndex').value = '';
            document.getElementById('testSampleSelect').value = '';
            document.getElementById('moisturePercent').value = '';
            document.getElementById('foreignMatterPercent').value = '';
            document.getElementById('colorGrade').value = '';
            document.getElementById('categoryResult').value = '';
            document.getElementById('testDate').value = '';
            document.getElementById('testNotes').value = '';

            // Reset lab decision buttons
            document.getElementById('approveQualityBtn').style.display = 'block';
            document.getElementById('raiseClaimBtn').style.display = 'block';

            if (index !== null) {
                const test = tests[index];
                document.getElementById('testEditIndex').value = index;
                document.getElementById('testSampleSelect').value = test.sampleId;
                document.getElementById('moisturePercent').value = test.moisturePercent;
                document.getElementById('foreignMatterPercent').value = test.foreignMatterPercent;
                document.getElementById('colorGrade').value = test.colorGrade;
                document.getElementById('categoryResult').value = test.category;
                document.getElementById('testDate').value = test.testDate;
                document.getElementById('testNotes').value = test.notes || '';
                document.querySelector('#testModal .modal-title').textContent = 'Edit Test Result';
            } else {
                document.querySelector('#testModal .modal-title').textContent = 'Lab Test Results & Quality Decision';
                setCurrentDateTime('testDate');
            }

            // Add event listeners for lab decision buttons
            document.getElementById('approveQualityBtn').onclick = () => setLabDecision('approved');
            document.getElementById('raiseClaimBtn').onclick = () => setLabDecision('claim');

            modal.show();
        }

        function setLabDecision(decision) {
            if (decision === 'approved') {
                document.getElementById('approveQualityBtn').classList.add('active');
                document.getElementById('raiseClaimBtn').classList.remove('active');
                showAlert('Quality approved - will be forwarded to Owner for category assignment', 'success');
            } else if (decision === 'claim') {
                document.getElementById('raiseClaimBtn').classList.add('active');
                document.getElementById('approveQualityBtn').classList.remove('active');
                showAlert('Quality claim will be raised - Owner will coordinate with supplier', 'warning');
            }
        }

        function saveTest() {
            const index = document.getElementById('testEditIndex').value;
            const sampleId = document.getElementById('testSampleSelect').value;
            const moisturePercent = parseFloat(document.getElementById('moisturePercent').value);
            const foreignMatterPercent = parseFloat(document.getElementById('foreignMatterPercent').value);
            const colorGrade = document.getElementById('colorGrade').value;
            const testDate = document.getElementById('testDate').value;
            const notes = document.getElementById('testNotes').value;

            if (!sampleId || !moisturePercent || !foreignMatterPercent || !colorGrade || !testDate) {
                showAlert('Please fill all required fields', 'warning');
                return;
            }

            // Check lab decision
            const isApproved = document.getElementById('approveQualityBtn').classList.contains('active');
            const isClaim = document.getElementById('raiseClaimBtn').classList.contains('active');

            if (!isApproved && !isClaim) {
                showAlert('Please select a lab decision (Quality Approved or Raise Claim)', 'warning');
                return;
            }

            const category = determineCategory(moisturePercent, foreignMatterPercent, colorGrade);
            const labDecision = isApproved ? 'Quality Approved' : 'Quality Claim Raised';

            const test = {
                sampleId: sampleId,
                moisturePercent: moisturePercent,
                foreignMatterPercent: foreignMatterPercent,
                colorGrade: colorGrade,
                category: category,
                testDate: testDate,
                notes: notes,
                labDecision: labDecision,
                status: isApproved ? 'Waiting for Owner Decision' : 'Quality Claim Raised',
                testId: index === '' ? 'TST' + Date.now() : tests[parseInt(index)].testId || 'TST' + Date.now()
            };

            if (index === '' || index === undefined) {
                tests.push(test);
                // Update sample status
                const sampleIndex = samples.findIndex(s => s.sampleId === test.sampleId);
                if (sampleIndex !== -1) {
                    samples[sampleIndex].status = 'Test Completed';
                }

                // Create notification for owner
                const sample = samples.find(s => s.sampleId === sampleId);
                const vehicle = vehicles.find(v => v.vehicleNumber === sample?.vehicleId);

                if (isApproved) {
                    addNotification(`Quality approved for vehicle ${vehicle?.vehicleNumber}. Awaiting your category assignment and storage decision.`, 'info');
                } else {
                    addNotification(`Quality claim raised for vehicle ${vehicle?.vehicleNumber}. Please coordinate with supplier ${vehicle?.supplier}.`, 'urgent');
                    // Auto-create claim record
                    createAutoClaim(test, vehicle);
                }
            } else {
                tests[parseInt(index)] = { ...tests[parseInt(index)], ...test };
            }

            saveDataToMemory();
            loadTestTable();
            updateDashboard();
            loadConfirmationTable();

            const testModal = bootstrap.Modal.getInstance(document.getElementById('testModal'));
            if (testModal) testModal.hide();

            showAlert(`Test result saved with lab decision: ${labDecision}`, 'success');
        }

        function createAutoClaim(test, vehicle) {
            const claim = {
                claimId: 'CLM' + Date.now(),
                vehicleNumber: vehicle?.vehicleNumber || 'Unknown',
                supplier: vehicle?.supplier || 'Unknown',
                testId: test.testId,
                reason: `Quality issues detected - Moisture: ${test.moisturePercent}%, Foreign Matter: ${test.foreignMatterPercent}%, Color: ${test.colorGrade}`,
                claimDate: new Date().toISOString(),
                status: 'Pending Supplier Contact',
                raisedBy: 'Lab Technician',
                supplierResponse: '',
                resolutionStatus: 'Open'
            };
            claims.push(claim);
        }

        function loadTestTable() {
            const tbody = document.getElementById('testTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            tests.forEach((test, index) => {
                const sample = samples.find(s => s.sampleId === test.sampleId);
                const vehicle = vehicles.find(v => v.vehicleNumber === sample?.vehicleId);
                const categoryBadge = getCategoryBadge(test.category);

                const qualityAssessment = test.labDecision === 'Quality Approved' ?
                    '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Approved</span>' :
                    '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> Claim Raised</span>';

                tbody.innerHTML += `
                    <tr>
                        <td>${test.sampleId}</td>
                        <td><strong>${sample ? sample.vehicleId : 'N/A'}</strong></td>
                        <td>
                            <small>Moisture: ${test.moisturePercent}%<br>
                            Foreign Matter: ${test.foreignMatterPercent}%<br>
                            Color: ${test.colorGrade}</small>
                        </td>
                        <td>${qualityAssessment}</td>
                        <td>${new Date(test.testDate).toLocaleString()}</td>
                        <td>
                            <span class="badge ${test.labDecision === 'Quality Approved' ? 'bg-success' : 'bg-warning'}">
                                ${test.labDecision}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openTestModal(${index})" title="Edit Test">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTest(${index})" title="Delete Test">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // Enhanced Owner Decision Management
        function loadConfirmationTable() {
            const tbody = document.getElementById('confirmationTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            // Get tests that need owner decision
            const pendingTests = tests.filter(test =>
                test.status === 'Waiting for Owner Decision' || test.status === 'Quality Claim Raised'
            );

            if (pendingTests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No pending decisions</td></tr>';
                return;
            }

            pendingTests.forEach((test, index) => {
                const sample = samples.find(s => s.sampleId === test.sampleId);
                const vehicle = vehicles.find(v => v.vehicleNumber === sample?.vehicleId);
                const decision = ownerDecisions.find(d => d.testId === test.testId);

                const qualityStatusBadge = test.labDecision === 'Quality Approved' ?
                    '<span class="badge bg-success">Lab Approved</span>' :
                    '<span class="badge bg-warning">Claim Raised</span>';

                const decisionStatus = decision ?
                    `<span class="badge bg-success">Decision Made</span>` :
                    `<span class="badge bg-warning">Pending Decision</span>`;

                const storageAssignment = decision ? decision.storageArea : 'Not Assigned';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${vehicle?.vehicleNumber || 'N/A'}</strong></td>
                        <td>${vehicle?.supplier || 'N/A'}</td>
                        <td>
                            <small>
                                Category: ${getCategoryBadge(test.category)}<br>
                                Moisture: ${test.moisturePercent}%<br>
                                Foreign Matter: ${test.foreignMatterPercent}%
                            </small>
                        </td>
                        <td>${qualityStatusBadge}</td>
                        <td><strong>${storageAssignment}</strong></td>
                        <td>${decisionStatus}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openOwnerDecisionModal('${test.testId}')" title="Make Decision">
                                <i class="fas fa-user-tie"></i> Decide
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function openOwnerDecisionModal(testId) {
            const modal = new bootstrap.Modal(document.getElementById('ownerDecisionModal'));
            const test = tests.find(t => t.testId === testId);
            const sample = samples.find(s => s.sampleId === test.sampleId);
            const vehicle = vehicles.find(v => v.vehicleNumber === sample?.vehicleId);

            document.getElementById('decisionTestIndex').value = testId;

            // Show appropriate section based on lab decision
            if (test.labDecision === 'Quality Approved') {
                document.getElementById('approvedWheatSection').style.display = 'block';
                document.getElementById('claimWheatSection').style.display = 'none';

                // Pre-fill with auto category
                document.getElementById('finalCategory').value = test.category;
            } else {
                document.getElementById('approvedWheatSection').style.display = 'none';
                document.getElementById('claimWheatSection').style.display = 'block';

                // Add change listener for supplier contact status
                document.getElementById('supplierContactStatus').addEventListener('change', function() {
                    const section = document.getElementById('claimResolutionSection');
                    if (this.value === 'Agreed') {
                        section.style.display = 'block';
                        document.getElementById('claimFinalCategory').value = test.category;
                    } else {
                        section.style.display = 'none';
                    }
                });
            }

            modal.show();
        }

        function saveOwnerDecision() {
            const testId = document.getElementById('decisionTestIndex').value;
            const test = tests.find(t => t.testId === testId);
            const ownerNotes = document.getElementById('ownerNotes').value;

            let decision = {
                testId: testId,
                decisionDate: new Date().toISOString(),
                decisionBy: 'Production Manager',
                ownerNotes: ownerNotes
            };

            if (test.labDecision === 'Quality Approved') {
                const finalCategory = document.getElementById('finalCategory').value;
                const storageArea = document.getElementById('storageArea').value;

                if (!finalCategory || !storageArea) {
                    showAlert('Please select final category and storage area', 'warning');
                    return;
                }

                decision = {
                    ...decision,
                    finalCategory: finalCategory,
                    storageArea: storageArea,
                    decisionType: 'Approved for Unloading',
                    status: 'Authorized for Unloading'
                };

                // Update test status
                test.status = 'Authorized for Unloading';

                addNotification(`Vehicle ${test.sampleId} authorized for unloading to ${storageArea}`, 'success');
            } else {
                const supplierContactStatus = document.getElementById('supplierContactStatus').value;
                const agreementDetails = document.getElementById('agreementDetails').value;

                if (!supplierContactStatus) {
                    showAlert('Please update supplier contact status', 'warning');
                    return;
                }

                decision = {
                    ...decision,
                    supplierContactStatus: supplierContactStatus,
                    agreementDetails: agreementDetails,
                    decisionType: 'Quality Claim Resolution'
                };

                if (supplierContactStatus === 'Agreed') {
                    const claimFinalCategory = document.getElementById('claimFinalCategory').value;
                    const claimStorageArea = document.getElementById('claimStorageArea').value;

                    if (!claimFinalCategory || !claimStorageArea) {
                        showAlert('Please select final category and storage area after agreement', 'warning');
                        return;
                    }

                    decision.finalCategory = claimFinalCategory;
                    decision.storageArea = claimStorageArea;
                    decision.status = 'Authorized for Unloading';
                    test.status = 'Authorized for Unloading';

                    // Update claim status
                    const claim = claims.find(c => c.testId === testId);
                    if (claim) {
                        claim.supplierResponse = 'Agreed';
                        claim.resolutionStatus = 'Resolved';
                        claim.status = 'Resolved - Authorized for Unloading';
                    }

                    addNotification(`Quality claim resolved. Vehicle authorized for unloading to ${claimStorageArea}`, 'success');
                } else {
                    decision.status = 'Pending Supplier Agreement';
                    test.status = 'Pending Supplier Agreement';
                    addNotification(`Supplier contact updated: ${supplierContactStatus}`, 'info');
                }
            }

            // Save or update decision
            const existingDecisionIndex = ownerDecisions.findIndex(d => d.testId === testId);
            if (existingDecisionIndex !== -1) {
                ownerDecisions[existingDecisionIndex] = decision;
            } else {
                ownerDecisions.push(decision);
            }

            saveDataToMemory();
            loadConfirmationTable();
            loadUnloadingTable();
            updateDashboard();

            const modal = bootstrap.Modal.getInstance(document.getElementById('ownerDecisionModal'));
            if (modal) modal.hide();

            showAlert('Owner decision recorded successfully!', 'success');
        }

        // Enhanced Unloading & Weight Management
        function openUnloadingModal(index = null) {
            const modal = new bootstrap.Modal(document.getElementById('unloadingModal'));
            populateAuthorizedVehicles();

            // Reset form
            document.getElementById('unloadingEditIndex').value = '';
            document.getElementById('unloadingVehicleSelect').value = '';
            document.getElementById('unloadingGrossWeight').value = '';
            document.getElementById('emptyWeight').value = '';
            document.getElementById('unloadingStartTime').value = '';
            document.getElementById('unloadingEndTime').value = '';
            document.getElementById('unloadingNotes').value = '';
            document.getElementById('netWeightValue').textContent = '0.0';

            if (index !== null) {
                const unloading = unloadings[index];
                document.getElementById('unloadingEditIndex').value = index;
                document.getElementById('unloadingVehicleSelect').value = unloading.vehicleNumber;
                document.getElementById('unloadingGrossWeight').value = unloading.grossWeight;
                document.getElementById('emptyWeight').value = unloading.emptyWeight;
                document.getElementById('unloadingStartTime').value = unloading.startTime;
                document.getElementById('unloadingEndTime').value = unloading.endTime;
                document.getElementById('unloadingNotes').value = unloading.notes || '';
                updateNetWeight();
                updateUnloadingPreview(unloading.vehicleNumber);
            } else {
                setCurrentDateTime('unloadingStartTime');
            }

            // Add event listeners
            document.getElementById('unloadingVehicleSelect').addEventListener('change', function() {
                updateUnloadingPreview(this.value);
            });

            document.getElementById('emptyWeight').addEventListener('input', updateNetWeight);

            modal.show();
        }

        function populateAuthorizedVehicles() {
            const select = document.getElementById('unloadingVehicleSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Select Authorized Vehicle</option>';

            // Get vehicles that are authorized for unloading
            const authorizedTests = tests.filter(t => t.status === 'Authorized for Unloading');

            authorizedTests.forEach(test => {
                const sample = samples.find(s => s.sampleId === test.sampleId);
                const vehicle = vehicles.find(v => v.vehicleNumber === sample?.vehicleId);
                const decision = ownerDecisions.find(d => d.testId === test.testId);

                if (vehicle && decision) {
                    select.innerHTML += `
                        <option value="${vehicle.vehicleNumber}">
                            ${vehicle.vehicleNumber} - ${vehicle.supplier} (${decision.finalCategory})
                        </option>
                    `;
                }
            });
        }

        function updateUnloadingPreview(vehicleNumber) {
            if (!vehicleNumber) {
                document.getElementById('previewStorageArea').textContent = '-';
                document.getElementById('previewCategory').textContent = '-';
                document.getElementById('previewWeight').textContent = '0.0';
                document.getElementById('unloadingGrossWeight').value = '';
                return;
            }

            const vehicle = vehicles.find(v => v.vehicleNumber === vehicleNumber);
            const sample = samples.find(s => s.vehicleId === vehicleNumber);
            const test = tests.find(t => t.sampleId === sample?.sampleId);
            const decision = ownerDecisions.find(d => d.testId === test?.testId);

            if (vehicle && decision) {
                document.getElementById('previewStorageArea').textContent = decision.storageArea;
                document.getElementById('previewCategory').textContent = decision.finalCategory;
                document.getElementById('unloadingGrossWeight').value = vehicle.grossWeight || '';
                updateNetWeight();
            }
        }

        function updateNetWeight() {
            const grossWeight = parseFloat(document.getElementById('unloadingGrossWeight').value) || 0;
            const emptyWeight = parseFloat(document.getElementById('emptyWeight').value) || 0;
            const netWeight = grossWeight - emptyWeight;

            document.getElementById('netWeightValue').textContent = netWeight.toFixed(1);
            document.getElementById('previewWeight').textContent = netWeight.toFixed(1);
        }

        function saveUnloading() {
            const index = document.getElementById('unloadingEditIndex').value;
            const vehicleNumber = document.getElementById('unloadingVehicleSelect').value;
            const grossWeight = parseFloat(document.getElementById('unloadingGrossWeight').value);
            const emptyWeight = parseFloat(document.getElementById('emptyWeight').value);
            const startTime = document.getElementById('unloadingStartTime').value;
            const endTime = document.getElementById('unloadingEndTime').value;
            const notes = document.getElementById('unloadingNotes').value;

            if (!vehicleNumber || !grossWeight || !emptyWeight || !startTime || !endTime) {
                showAlert('Please fill all required fields', 'warning');
                return;
            }

            if (emptyWeight >= grossWeight) {
                showAlert('Empty weight cannot be greater than or equal to gross weight', 'warning');
                return;
            }

            const netWeight = grossWeight - emptyWeight;

            // Get vehicle and decision details
            const vehicle = vehicles.find(v => v.vehicleNumber === vehicleNumber);
            const sample = samples.find(s => s.vehicleId === vehicleNumber);
            const test = tests.find(t => t.sampleId === sample?.sampleId);
            const decision = ownerDecisions.find(d => d.testId === test?.testId);

            const unloading = {
                vehicleNumber: vehicleNumber,
                supplier: vehicle.supplier,
                grossWeight: grossWeight,
                emptyWeight: emptyWeight,
                netWeight: netWeight,
                category: decision.finalCategory,
                storageArea: decision.storageArea,
                startTime: startTime,
                endTime: endTime,
                notes: notes,
                status: 'Completed',
                completedDate: new Date().toISOString()
            };

            if (index === '' || index === undefined) {
                unloadings.push(unloading);

                // Update inventory
                updateInventory(decision.storageArea, decision.finalCategory, netWeight, vehicleNumber);

                // Update vehicle status
                const vehicleIndex = vehicles.findIndex(v => v.vehicleNumber === vehicleNumber);
                if (vehicleIndex !== -1) {
                    vehicles[vehicleIndex].status = 'Unloading Completed';
                }

                // Generate receipt
                generateDeliveryReceipt(unloading);

                addNotification(`Unloading completed for ${vehicleNumber}. Net weight: ${netWeight.toFixed(1)} MT added to inventory.`, 'success');
            } else {
                unloadings[parseInt(index)] = unloading;
            }

            saveDataToMemory();
            loadUnloadingTable();
            loadInventoryModule();
            updateDashboard();

            const modal = bootstrap.Modal.getInstance(document.getElementById('unloadingModal'));
            if (modal) modal.hide();

            showAlert(`Unloading completed successfully! Net weight: ${netWeight.toFixed(1)} MT`, 'success');
        }

        function loadUnloadingTable() {
            const tbody = document.getElementById('unloadingTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (unloadings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No unloading records</td></tr>';
                return;
            }

            unloadings.forEach((unloading, index) => {
                const statusBadge = unloading.status === 'Completed' ?
                    '<span class="badge bg-success">Completed</span>' :
                    '<span class="badge bg-warning">In Progress</span>';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${unloading.vehicleNumber}</strong></td>
                        <td>${unloading.storageArea}</td>
                        <td>${unloading.grossWeight} MT</td>
                        <td>${unloading.emptyWeight} MT</td>
                        <td><strong class="text-success">${unloading.netWeight.toFixed(1)} MT</strong></td>
                        <td>${new Date(unloading.startTime).toLocaleString()}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openUnloadingModal(${index})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="showDeliveryReceipt('${unloading.vehicleNumber}')" title="View Receipt">
                                <i class="fas fa-receipt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUnloading(${index})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // Inventory Management Functions
        function initializeInventory() {
            if (Object.keys(inventory).length === 0) {
                inventory = {
                    'Godown A': { Premium: 0, Mill: 0, 'Low Mill': 0 },
                    'Godown B': { Premium: 0, Mill: 0, 'Low Mill': 0 },
                    'Godown C': { Premium: 0, Mill: 0, 'Low Mill': 0 },
                    'Warehouse 1': { Premium: 0, Mill: 0, 'Low Mill': 0 },
                    'Warehouse 2': { Premium: 0, Mill: 0, 'Low Mill': 0 }
                };
            }
        }

        function updateInventory(storageArea, category, weight, vehicleNumber) {
            if (!inventory[storageArea]) {
                inventory[storageArea] = { Premium: 0, Mill: 0, 'Low Mill': 0 };
            }

            inventory[storageArea][category] = (inventory[storageArea][category] || 0) + weight;

            // Add to history
            inventoryHistory.unshift({
                date: new Date().toISOString(),
                vehicleNumber: vehicleNumber,
                category: category,
                weight: weight,
                storageArea: storageArea
            });

            // Keep only last 50 entries
            if (inventoryHistory.length > 50) {
                inventoryHistory = inventoryHistory.slice(0, 50);
            }
        }

        function loadInventoryModule() {
            loadStorageAreas();
            loadCategoryBreakdown();
            loadInventoryHistory();
        }

        function loadStorageAreas() {
            const container = document.getElementById('storageAreas');
            if (!container) return;

            let html = '';
            Object.keys(inventory).forEach(area => {
                const areaInventory = inventory[area];
                const totalWeight = Object.values(areaInventory).reduce((sum, weight) => sum + weight, 0);

                html += `
                    <div class="mb-3 p-3 border rounded">
                        <h6><i class="fas fa-warehouse"></i> ${area}</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">Premium</small><br>
                                <strong>${areaInventory.Premium.toFixed(1)} MT</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Mill</small><br>
                                <strong>${areaInventory.Mill.toFixed(1)} MT</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Low Mill</small><br>
                                <strong>${areaInventory['Low Mill'].toFixed(1)} MT</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <strong>Total: ${totalWeight.toFixed(1)} MT</strong>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function loadCategoryBreakdown() {
            const container = document.getElementById('categoryBreakdown');
            if (!container) return;

            const totals = { Premium: 0, Mill: 0, 'Low Mill': 0 };

            Object.values(inventory).forEach(area => {
                totals.Premium += area.Premium;
                totals.Mill += area.Mill;
                totals['Low Mill'] += area['Low Mill'];
            });

            const grandTotal = Object.values(totals).reduce((sum, weight) => sum + weight, 0);

            let html = `
                <div class="text-center mb-3">
                    <h4>${grandTotal.toFixed(1)} MT</h4>
                    <small class="text-muted">Total Inventory</small>
                </div>
            `;

            Object.keys(totals).forEach(category => {
                const weight = totals[category];
                const percentage = grandTotal > 0 ? (weight / grandTotal * 100) : 0;

                html += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${category}</span>
                            <span><strong>${weight.toFixed(1)} MT</strong></span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                        </div>
                        <small class="text-muted">${percentage.toFixed(1)}%</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function loadInventoryHistory() {
            const tbody = document.getElementById('inventoryHistoryBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (inventoryHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No inventory updates yet</td></tr>';
                return;
            }

            inventoryHistory.slice(0, 20).forEach(entry => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(entry.date).toLocaleString()}</td>
                        <td><strong>${entry.vehicleNumber}</strong></td>
                        <td><span class="badge bg-primary">${entry.category}</span></td>
                        <td><strong class="text-success">+${entry.weight.toFixed(1)} MT</strong></td>
                        <td>${entry.storageArea}</td>
                    </tr>
                `;
            });
        }

        // Delivery Receipt Functions
        function generateDeliveryReceipt(unloading) {
            const vehicle = vehicles.find(v => v.vehicleNumber === unloading.vehicleNumber);
            const receiptData = {
                receiptNumber: 'RCP' + Date.now(),
                vehicleNumber: unloading.vehicleNumber,
                driverName: vehicle?.driverName || 'N/A',
                supplier: unloading.supplier,
                category: unloading.category,
                storageArea: unloading.storageArea,
                grossWeight: unloading.grossWeight,
                emptyWeight: unloading.emptyWeight,
                netWeight: unloading.netWeight,
                unloadingDate: new Date(unloading.startTime).toLocaleDateString(),
                unloadingTime: new Date(unloading.startTime).toLocaleTimeString(),
                generatedDate: new Date().toLocaleString()
            };

            // Store receipt data for later use
            if (!vehicle.receiptData) {
                vehicle.receiptData = receiptData;
            }

            return receiptData;
        }

        function showDeliveryReceipt(vehicleNumber) {
            const unloading = unloadings.find(u => u.vehicleNumber === vehicleNumber);
            const vehicle = vehicles.find(v => v.vehicleNumber === vehicleNumber);

            if (!unloading || !vehicle) {
                showAlert('Receipt data not found', 'error');
                return;
            }

            const receiptData = generateDeliveryReceipt(unloading);

            const receiptHtml = `
                <div class="text-center mb-4">
                    <h4><i class="fas fa-seedling"></i> Wheat Quality Management System</h4>
                    <h5>Delivery Receipt</h5>
                    <hr>
                </div>

                <div class="row">
                    <div class="col-6">
                        <p><strong>Receipt No:</strong> ${receiptData.receiptNumber}</p>
                        <p><strong>Date:</strong> ${receiptData.unloadingDate}</p>
                        <p><strong>Time:</strong> ${receiptData.unloadingTime}</p>
                    </div>
                    <div class="col-6">
                        <p><strong>Vehicle No:</strong> ${receiptData.vehicleNumber}</p>
                        <p><strong>Driver:</strong> ${receiptData.driverName}</p>
                        <p><strong>Supplier:</strong> ${receiptData.supplier}</p>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-6">
                        <p><strong>Category:</strong> <span class="badge bg-primary">${receiptData.category}</span></p>
                        <p><strong>Storage Area:</strong> ${receiptData.storageArea}</p>
                    </div>
                    <div class="col-6">
                        <p><strong>Gross Weight:</strong> ${receiptData.grossWeight} MT</p>
                        <p><strong>Empty Weight:</strong> ${receiptData.emptyWeight} MT</p>
                        <p><strong>Net Weight:</strong> <span class="text-success fw-bold">${receiptData.netWeight.toFixed(1)} MT</span></p>
                    </div>
                </div>

                <hr>

                <div class="text-center">
                    <p><strong>Status: DELIVERED & INVENTORY UPDATED</strong></p>
                    <small class="text-muted">Generated on: ${receiptData.generatedDate}</small>
                </div>

                <div class="mt-4 text-center">
                    <p><small>This is a computer-generated receipt.</small></p>
                </div>
            `;

            document.getElementById('receiptContent').innerHTML = receiptHtml;
            const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
            modal.show();
        }

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            showAlert('PDF download functionality would be implemented with a PDF library in production', 'info');
        }

        // Enhanced Claims Management
        function loadClaimTable() {
            const tbody = document.getElementById('claimTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (claims.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No quality claims</td></tr>';
                return;
            }

            claims.forEach((claim, index) => {
                const statusBadge = getClaimStatusBadge(claim.resolutionStatus);
                const supplierResponseBadge = claim.supplierResponse ?
                    `<span class="badge bg-info">${claim.supplierResponse}</span>` :
                    '<span class="text-muted">Pending</span>';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${claim.claimId}</strong></td>
                        <td>${claim.vehicleNumber}</td>
                        <td>${claim.supplier}</td>
                        <td>
                            <small>${claim.reason}</small>
                        </td>
                        <td>${new Date(claim.claimDate).toLocaleString()}</td>
                        <td>${supplierResponseBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewClaimDetails('${claim.claimId}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="updateClaimStatus('${claim.claimId}')" title="Update Status">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function getClaimStatusBadge(status) {
            const badges = {
                'Open': 'bg-warning',
                'Resolved': 'bg-success',
                'Rejected': 'bg-danger',
                'Under Review': 'bg-info'
            };
            return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
        }

        // Notification System
        function addNotification(message, type = 'info') {
            const notification = {
                id: Date.now(),
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false
            };

            notifications.unshift(notification);
            updateNotificationCount();
            showAlert(message, type);
        }

        function updateNotificationCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            document.getElementById('notificationCount').textContent = unreadCount;
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel.style.display === 'none') {
                loadNotifications();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function loadNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (!panel) return;

            let html = '<h6 class="p-2 bg-primary text-white">Notifications</h6>';

            if (notifications.length === 0) {
                html += '<div class="notification-item">No notifications</div>';
            } else {
                notifications.slice(0, 10).forEach(notification => {
                    const typeClass = notification.type === 'urgent' ? 'notification-urgent' : 'notification-info';
                    const timeAgo = getTimeAgo(notification.timestamp);

                    html += `
                        <div class="notification-item ${typeClass}" onclick="markNotificationRead('${notification.id}')">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${timeAgo}</small>
                                ${!notification.read ? '<span class="badge bg-danger">New</span>' : ''}
                            </div>
                            <p class="mb-0">${notification.message}</p>
                        </div>
                    `;
                });
            }

            panel.innerHTML = html;
        }

        function markNotificationRead(notificationId) {
            const notification = notifications.find(n => n.id == notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationCount();
            }
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        // Workflow Status Display
        function updateWorkflowStatus() {
            const container = document.getElementById('workflowStatus');
            if (!container) return;

            const steps = [
                {
                    name: 'Vehicle Registration',
                    count: vehicles.length,
                    status: vehicles.length > 0 ? 'complete' : 'pending',
                    icon: 'fas fa-truck'
                },
                {
                    name: 'Sample Collection',
                    count: samples.length,
                    status: samples.length > 0 ? 'complete' : 'pending',
                    icon: 'fas fa-flask'
                },
                {
                    name: 'Lab Testing',
                    count: tests.length,
                    status: tests.length > 0 ? 'complete' : 'pending',
                    icon: 'fas fa-microscope'
                },
                {
                    name: 'Owner Decisions',
                    count: ownerDecisions.length,
                    status: tests.filter(t => t.status === 'Waiting for Owner Decision' || t.status === 'Quality Claim Raised').length > 0 ? 'active' : 'pending',
                    icon: 'fas fa-user-tie'
                },
                {
                    name: 'Unloading Complete',
                    count: unloadings.length,
                    status: unloadings.length > 0 ? 'complete' : 'pending',
                    icon: 'fas fa-warehouse'
                }
            ];

            let html = '<div class="row">';
            steps.forEach(step => {
                const stepClass = step.status === 'complete' ? 'step-complete' :
                                step.status === 'active' ? 'step-active' : '';

                html += `
                    <div class="col">
                        <div class="workflow-step ${stepClass}">
                            <div class="text-center">
                                <i class="${step.icon} fa-2x mb-2"></i>
                                <h6>${step.name}</h6>
                                <h4>${step.count}</h4>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // Enhanced Dashboard Updates
        function updateDashboard() {
            const totalVehiclesEl = document.getElementById('totalVehicles');
            const pendingDecisionsEl = document.getElementById('pendingDecisions');
            const activeClaimsEl = document.getElementById('activeClaims');
            const todayInventoryEl = document.getElementById('todayInventory');

            if (totalVehiclesEl) totalVehiclesEl.textContent = vehicles.length;

            const pendingDecisions = tests.filter(t =>
                t.status === 'Waiting for Owner Decision' || t.status === 'Quality Claim Raised'
            ).length;
            if (pendingDecisionsEl) pendingDecisionsEl.textContent = pendingDecisions;

            const activeClaims = claims.filter(c => c.resolutionStatus === 'Open').length;
            if (activeClaimsEl) activeClaimsEl.textContent = activeClaims;

            // Calculate today's inventory additions
            const today = new Date().toDateString();
            const todayInventory = inventoryHistory
                .filter(entry => new Date(entry.date).toDateString() === today)
                .reduce((sum, entry) => sum + entry.weight, 0);
            if (todayInventoryEl) todayInventoryEl.textContent = todayInventory.toFixed(1);
        }

        // Enhanced Camera Functions (keeping existing functionality)
        function initializeCameraControls() {
            const startCameraBtn = document.getElementById('startCameraBtn');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const fileInput = document.getElementById('fileInput');

            if (startCameraBtn) startCameraBtn.addEventListener('click', startCamera);
            if (stopCameraBtn) stopCameraBtn.addEventListener('click', stopCamera);
            if (captureBtn) captureBtn.addEventListener('click', capturePhoto);
            if (fileInput) fileInput.addEventListener('change', handleFileUpload);
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } }
                });

                const video = document.getElementById('cameraVideo');
                if (video) {
                    video.srcObject = stream;
                    currentStream = stream;

                    const cameraSection = document.getElementById('cameraSection');
                    const startBtn = document.getElementById('startCameraBtn');

                    if (cameraSection) cameraSection.style.display = 'block';
                    if (startBtn) startBtn.style.display = 'none';

                    showAlert('Camera started successfully', 'success');
                }
            } catch (error) {
                console.error('Error accessing camera:', error);
                showAlert('Unable to access camera. Please check permissions.', 'danger');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;

                const cameraSection = document.getElementById('cameraSection');
                const startBtn = document.getElementById('startCameraBtn');

                if (cameraSection) cameraSection.style.display = 'none';
                if (startBtn) startBtn.style.display = 'inline-block';

                showAlert('Camera stopped', 'info');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            if (!video) return;

            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            addPhotoToPreview(imageData, `Photo_${Date.now()}.jpg`);

            showAlert('Photo captured successfully', 'success');
        }

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addPhotoToPreview(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
            showAlert(`${files.length} photo(s) uploaded`, 'success');
        }

        function addPhotoToPreview(imageData, fileName) {
            const previewContainer = document.getElementById('photoPreview');
            if (!previewContainer) return;

            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.innerHTML = `
                <img src="${imageData}" alt="${fileName}" />
                <button type="button" class="photo-delete" onclick="removePhoto(this)">&times;</button>
                <div class="mt-1 text-center">
                    <small class="text-muted">${fileName}</small>
                </div>
            `;
            previewContainer.appendChild(photoItem);
        }

        function removePhoto(button) {
            if (button && button.parentElement) {
                button.parentElement.remove();
            }
        }

        function getVehiclePhotos() {
            const photoItems = document.querySelectorAll('.photo-item img');
            return Array.from(photoItems).map(img => ({
                data: img.src,
                name: img.alt,
                timestamp: new Date().toISOString()
            }));
        }

        function expandPhoto(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Photo View</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageSrc}" style="max-width: 100%; height: auto;">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // Utility Functions
        function saveDataToMemory() {
            // In a real application, this would save to a database
            console.log('Data saved to memory storage');
        }

        function loadData() {
            // Initialize with sample data if empty
            if (suppliers.length === 0) {
                suppliers = [{
                    name: "Premium Wheat Suppliers Ltd",
                    contactPerson: "John Smith",
                    phone: "123-456-7890",
                    email: "john@premiumwheat.com",
                    address: "123 Wheat Street, Grain City",
                    status: "Active",
                    createdDate: new Date().toISOString()
                }];
            }
        }

        function determineCategory(moisture, foreignMatter, color) {
            if (moisture <= 12 && foreignMatter <= 1 && (color === 'Excellent' || color === 'Good')) {
                return 'Premium';
            } else if (moisture <= 14 && foreignMatter <= 2 && (color === 'Good' || color === 'Fair')) {
                return 'Mill';
            } else {
                return 'Low Mill';
            }
        }

        function populateSupplierDropdowns() {
            const select = document.getElementById('supplierSelect');
            if (select) {
                select.innerHTML = '<option value="">Select Supplier</option>';
                suppliers.filter(s => s.status === 'Active').forEach(supplier => {
                    select.innerHTML += `<option value="${supplier.name}">${supplier.name}</option>`;
                });
            }
        }

        function populateVehicleDropdowns() {
            const select = document.getElementById('sampleVehicleSelect');
            if (select) {
                select.innerHTML = '<option value="">Select Vehicle</option>';
                vehicles.filter(v => v.status.includes('Pending Sampling') || v.status.includes('Sample Collected')).forEach(vehicle => {
                    select.innerHTML += `<option value="${vehicle.vehicleNumber}">${vehicle.vehicleNumber} - ${vehicle.supplier}</option>`;
                });
            }
        }

        function populateSampleDropdowns() {
            const select = document.getElementById('testSampleSelect');
            if (select) {
                select.innerHTML = '<option value="">Select Sample</option>';
                samples.filter(s => s.status === 'Pending Test').forEach(sample => {
                    select.innerHTML += `<option value="${sample.sampleId}">${sample.sampleId} - ${sample.vehicleId}</option>`;
                });
            }
        }

        function getStatusClass(status) {
            const statusClasses = {
                'Photos Captured - Pending Sampling': 'bg-info',
                'Sample Collected': 'bg-primary',
                'Test Completed': 'bg-warning',
                'Authorized for Unloading': 'bg-success',
                'Unloading Completed': 'bg-secondary',
                'Pending Test': 'bg-warning',
                'Waiting for Owner Decision': 'bg-info',
                'Quality Claim Raised': 'bg-danger'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        function getCategoryBadge(category) {
            const categoryClasses = {
                'Premium': 'bg-success',
                'Mill': 'bg-primary',
                'Low Mill': 'bg-warning',
                'Rejected': 'bg-danger'
            };
            return `<span class="badge ${categoryClasses[category] || 'bg-secondary'}">${category}</span>`;
        }

        function setCurrentDateTime(elementId = null) {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) element.value = localDateTime;
            }
        }

        function showAlert(message, type = 'info') {
            const typeMap = {
                'error': 'danger',
                'success': 'success',
                'warning': 'warning',
                'info': 'info'
            };
            const alertType = typeMap[type] || type;

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${alertType} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showAlert('Logged out successfully!', 'success');
            }
        }

        // Enhanced Sample Management Functions
        function openSampleModal(index = null) {
            const modal = new bootstrap.Modal(document.getElementById('sampleModal'));
            populateVehicleDropdowns();

            // Reset form
            document.getElementById('sampleEditIndex').value = '';
            document.getElementById('sampleVehicleSelect').value = '';
            document.getElementById('samplingTime').value = '';
            document.getElementById('bagsCount').value = '';
            document.getElementById('sampleNotes').value = '';

            if (index !== null) {
                const sample = samples[index];
                document.getElementById('sampleEditIndex').value = index;
                document.getElementById('sampleVehicleSelect').value = sample.vehicleId;
                document.getElementById('samplingTime').value = sample.samplingTime;
                document.getElementById('bagsCount').value = sample.bagsCount;
                document.getElementById('sampleNotes').value = sample.notes || '';
                document.querySelector('#sampleModal .modal-title').textContent = 'Edit Sample Entry';
            } else {
                document.querySelector('#sampleModal .modal-title').textContent = 'Sample Collection';
                setCurrentDateTime('samplingTime');
            }
            modal.show();
        }

        function saveSample() {
            const index = document.getElementById('sampleEditIndex').value;
            const vehicleId = document.getElementById('sampleVehicleSelect').value;
            const samplingTime = document.getElementById('samplingTime').value;
            const bagsCount = document.getElementById('bagsCount').value;
            const notes = document.getElementById('sampleNotes').value;

            if (!vehicleId || !samplingTime || !bagsCount) {
                showAlert('Please fill all required fields', 'warning');
                return;
            }

            if (parseInt(bagsCount) < 40 || parseInt(bagsCount) > 50) {
                showAlert('Number of bags should be between 40-50 as per sampling standards', 'warning');
                return;
            }

            const sample = {
                sampleId: index === '' ? 'SMP' + Date.now() : samples[parseInt(index)].sampleId,
                vehicleId: vehicleId,
                samplingTime: samplingTime,
                bagsCount: parseInt(bagsCount),
                notes: notes,
                status: 'Pending Test',
                collectedBy: 'Sampling Team',
                createdDate: new Date().toISOString()
            };

            if (index === '' || index === undefined) {
                samples.push(sample);

                // Update vehicle status
                const vehicleIndex = vehicles.findIndex(v => v.vehicleNumber === sample.vehicleId);
                if (vehicleIndex !== -1) {
                    vehicles[vehicleIndex].status = 'Sample Collected - Pending Lab Test';
                }

                addNotification(`Sample ${sample.sampleId} collected from vehicle ${vehicleId}. Ready for lab testing.`, 'info');
            } else {
                samples[parseInt(index)] = { ...samples[parseInt(index)], ...sample };
                addNotification(`Sample ${sample.sampleId} updated successfully.`, 'info');
            }

            saveDataToMemory();
            loadSampleTable();
            loadVehicleTable();
            updateDashboard();
            populateSampleDropdowns();

            const sampleModal = bootstrap.Modal.getInstance(document.getElementById('sampleModal'));
            if (sampleModal) sampleModal.hide();

            showAlert(`Sample ${sample.sampleId} saved successfully!`, 'success');
        }

        function loadSampleTable() {
            const tbody = document.getElementById('sampleTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (samples.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No samples collected yet</td></tr>';
                return;
            }

            samples.forEach((sample, index) => {
                const vehicle = vehicles.find(v => v.vehicleNumber === sample.vehicleId);
                const statusClass = getStatusClass(sample.status);

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${sample.sampleId}</strong></td>
                        <td>${sample.vehicleId}</td>
                        <td>${vehicle ? vehicle.supplier : 'N/A'}</td>
                        <td>${new Date(sample.samplingTime).toLocaleString()}</td>
                        <td><span class="badge bg-primary">${sample.bagsCount} bags</span></td>
                        <td><span class="badge ${statusClass}">${sample.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openSampleModal(${index})" title="Edit Sample">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info me-1" onclick="viewSampleDetails(${index})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSample(${index})" title="Delete Sample">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function viewSampleDetails(index) {
            const sample = samples[index];
            const vehicle = vehicles.find(v => v.vehicleNumber === sample.vehicleId);

            const detailsHtml = `
                <div class="modal fade" id="sampleDetailsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Sample Details - ${sample.sampleId}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-6"><strong>Sample ID:</strong></div>
                                    <div class="col-6">${sample.sampleId}</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6"><strong>Vehicle Number:</strong></div>
                                    <div class="col-6">${sample.vehicleId}</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6"><strong>Supplier:</strong></div>
                                    <div class="col-6">${vehicle ? vehicle.supplier : 'N/A'}</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6"><strong>Sampling Time:</strong></div>
                                    <div class="col-6">${new Date(sample.samplingTime).toLocaleString()}</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6"><strong>Bags Sampled:</strong></div>
                                    <div class="col-6">${sample.bagsCount} bags</div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6"><strong>Status:</strong></div>
                                    <div class="col-6"><span class="badge ${getStatusClass(sample.status)}">${sample.status}</span></div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-6"><strong>Collected By:</strong></div>
                                    <div class="col-6">${sample.collectedBy}</div>
                                </div>
                                ${sample.notes ? `
                                <div class="row mt-2">
                                    <div class="col-12"><strong>Notes:</strong></div>
                                    <div class="col-12 mt-1">${sample.notes}</div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('sampleDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', detailsHtml);
            const modal = new bootstrap.Modal(document.getElementById('sampleDetailsModal'));
            modal.show();
        }

        function deleteSample(index) {
            if (confirm('Are you sure you want to delete this sample? This action cannot be undone.')) {
                const sample = samples[index];

                // Update vehicle status back to pending sampling
                const vehicleIndex = vehicles.findIndex(v => v.vehicleNumber === sample.vehicleId);
                if (vehicleIndex !== -1) {
                    vehicles[vehicleIndex].status = 'Photos Captured - Pending Sampling';
                }

                samples.splice(index, 1);
                saveDataToMemory();
                loadSampleTable();
                loadVehicleTable();
                updateDashboard();
                populateSampleDropdowns();

                addNotification(`Sample ${sample.sampleId} deleted successfully.`, 'info');
                showAlert('Sample deleted successfully!', 'success');
            }
        }

        // Enhanced Supplier Management Functions
        function openSupplierModal(index = null) {
            const modal = new bootstrap.Modal(document.getElementById('supplierModal'));

            // Reset form
            document.getElementById('supplierEditIndex').value = '';
            document.getElementById('supplierName').value = '';
            document.getElementById('contactPerson').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierStatus').value = 'Active';

            if (index !== null) {
                const supplier = suppliers[index];
                document.getElementById('supplierEditIndex').value = index;
                document.getElementById('supplierName').value = supplier.name;
                document.getElementById('contactPerson').value = supplier.contactPerson;
                document.getElementById('supplierPhone').value = supplier.phone;
                document.getElementById('supplierEmail').value = supplier.email || '';
                document.getElementById('supplierAddress').value = supplier.address;
                document.getElementById('supplierStatus').value = supplier.status;
                document.querySelector('#supplierModal .modal-title').textContent = 'Edit Supplier';
            } else {
                document.querySelector('#supplierModal .modal-title').textContent = 'Add Supplier';
            }
            modal.show();
        }

        function saveSupplier() {
            const index = document.getElementById('supplierEditIndex').value;
            const name = document.getElementById('supplierName').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const phone = document.getElementById('supplierPhone').value;
            const email = document.getElementById('supplierEmail').value;
            const address = document.getElementById('supplierAddress').value;
            const status = document.getElementById('supplierStatus').value;

            if (!name || !contactPerson || !phone || !address) {
                showAlert('Please fill all required fields', 'warning');
                return;
            }

            const supplier = {
                name: name,
                contactPerson: contactPerson,
                phone: phone,
                email: email,
                address: address,
                status: status,
                createdDate: index === '' ? new Date().toISOString() : (suppliers[parseInt(index)]?.createdDate || new Date().toISOString()),
                updatedDate: new Date().toISOString()
            };

            if (index === '' || index === undefined) {
                suppliers.push(supplier);
                addNotification(`New supplier "${name}" added to the system.`, 'info');
            } else {
                suppliers[parseInt(index)] = supplier;
                addNotification(`Supplier "${name}" updated successfully.`, 'info');
            }

            saveDataToMemory();
            loadSupplierTable();
            populateSupplierDropdowns();

            const supplierModal = bootstrap.Modal.getInstance(document.getElementById('supplierModal'));
            if (supplierModal) supplierModal.hide();

            showAlert('Supplier saved successfully!', 'success');
        }

        function loadSupplierTable() {
            const tbody = document.getElementById('supplierTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (suppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No suppliers registered</td></tr>';
                return;
            }

            suppliers.forEach((supplier, index) => {
                const statusClass = supplier.status === 'Active' ? 'bg-success' :
                                  supplier.status === 'Inactive' ? 'bg-secondary' : 'bg-warning';
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${supplier.name}</strong></td>
                        <td>${supplier.contactPerson}</td>
                        <td>${supplier.phone}</td>
                        <td><small>${supplier.address}</small></td>
                        <td><span class="badge ${statusClass}">${supplier.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="openSupplierModal(${index})" title="Edit Supplier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${index})" title="Delete Supplier">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function deleteSupplier(index) {
            const supplier = suppliers[index];

            // Check if supplier has active vehicles
            const activeVehicles = vehicles.filter(v => v.supplier === supplier.name);
            if (activeVehicles.length > 0) {
                showAlert(`Cannot delete supplier "${supplier.name}" as they have ${activeVehicles.length} active vehicle(s) in the system.`, 'warning');
                return;
            }

            if (confirm(`Are you sure you want to delete supplier "${supplier.name}"?`)) {
                suppliers.splice(index, 1);
                saveDataToMemory();
                loadSupplierTable();
                populateSupplierDropdowns();

                addNotification(`Supplier "${supplier.name}" deleted from the system.`, 'info');
                showAlert('Supplier deleted successfully!', 'success');
            }
        }

        function openClaimModal() {
            showAlert('Manual claim entry functionality available', 'info');
        }

        function saveClaim() {
            showAlert('Claim saved successfully!', 'success');
        }

        function loadReports() {
            const dailySummary = document.getElementById('dailySummary');
            const qualityAnalysis = document.getElementById('qualityAnalysis');
            const supplierPerformance = document.getElementById('supplierPerformance');

            if (dailySummary) dailySummary.innerHTML = '<p>Enhanced reporting with workflow analytics</p>';
            if (qualityAnalysis) qualityAnalysis.innerHTML = '<p>Quality trends and claim analysis</p>';
            if (supplierPerformance) supplierPerformance.innerHTML = '<p>Supplier performance metrics</p>';
        }

        // Global function assignments for onclick handlers
        window.showModule = showModule;
        window.openVehicleModal = openVehicleModal;
        window.saveVehicle = saveVehicle;
        window.deleteVehicle = (index) => { showAlert('Delete functionality maintained', 'info'); };
        window.viewVehiclePhotos = viewVehiclePhotos;
        window.openSupplierModal = openSupplierModal;
        window.saveSupplier = saveSupplier;
        window.deleteSupplier = deleteSupplier;
        window.openSampleModal = openSampleModal;
        window.saveSample = saveSample;
        window.deleteSample = deleteSample;
        window.viewSampleDetails = viewSampleDetails;
        window.openTestModal = openTestModal;
        window.saveTest = saveTest;
        window.deleteTest = (index) => { showAlert('Delete functionality maintained', 'info'); };
        window.openOwnerDecisionModal = openOwnerDecisionModal;
        window.saveOwnerDecision = saveOwnerDecision;
        window.openUnloadingModal = openUnloadingModal;
        window.saveUnloading = saveUnloading;
        window.deleteUnloading = (index) => { showAlert('Delete functionality maintained', 'info'); };
        window.showDeliveryReceipt = showDeliveryReceipt;
        window.printReceipt = printReceipt;
        window.downloadReceipt = downloadReceipt;
        window.generateInventoryReport = () => { showAlert('Inventory report generation functionality', 'info'); };
        window.viewClaimDetails = (claimId) => { showAlert(`Viewing claim ${claimId}`, 'info'); };
        window.updateClaimStatus = (claimId) => { showAlert(`Updating claim ${claimId}`, 'info'); };
        window.toggleNotifications = toggleNotifications;
        window.markNotificationRead = markNotificationRead;
        window.removePhoto = removePhoto;
        window.expandPhoto = expandPhoto;
        window.logout = logout;

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();

            // Add event listeners for real-time category calculation
            const moistureInput = document.getElementById('moisturePercent');
            const foreignMatterInput = document.getElementById('foreignMatterPercent');
            const colorSelect = document.getElementById('colorGrade');

            if (moistureInput) {
                moistureInput.addEventListener('input', updateTestCategory);
            }
            if (foreignMatterInput) {
                foreignMatterInput.addEventListener('input', updateTestCategory);
            }
            if (colorSelect) {
                colorSelect.addEventListener('change', updateTestCategory);
            }

            function updateTestCategory() {
                const moisture = parseFloat(moistureInput?.value) || 0;
                const foreignMatter = parseFloat(foreignMatterInput?.value) || 0;
                const color = colorSelect?.value || '';

                if (moisture && foreignMatter && color) {
                    const category = determineCategory(moisture, foreignMatter, color);
                    const categoryResult = document.getElementById('categoryResult');
                    if (categoryResult) categoryResult.value = category;
                }
            }
        });

        // Auto-refresh dashboard and notifications
        setInterval(() => {
            updateDashboard();
            updateNotificationCount();
        }, 30000);

        // Cleanup camera stream when page unloads
        window.addEventListener('beforeunload', function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>